name: Continuous Deployment (CD)

# Trigger CD only after CI workflow completes successfully
on:
  workflow_run:
    workflows: ["Continuous Integration (CI)"]  # Must match the name in ci.yml
    types:
      - completed
    branches:
      - staging
      - main

jobs:
  # Job to check if CI was successful
  check-ci-success:
    name: Check CI Status
    runs-on: ubuntu-latest
    # Only run if the triggering workflow (CI) was successful
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      branch: ${{ steps.extract-branch.outputs.branch }}

    steps:
      - name: Extract branch name
        id: extract-branch
        run: |
          echo "branch=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
          echo "CI completed successfully on branch: ${{ github.event.workflow_run.head_branch }}"

  # Dummy deployment to STAGING environment
  deploy-staging:
    name: Deploy to Staging (Dummy)
    runs-on: ubuntu-latest
    needs: check-ci-success
    # Only run if branch is 'staging'
    if: ${{ github.event.workflow_run.head_branch == 'staging' }}
    environment:
      name: staging
      url: https://staging.yomu-bacaan-dan-kuis.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Dummy Deployment - Staging
        run: |
          echo "========================================"
          echo "üöÄ Dummy Deployment: STAGING"
          echo "========================================"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.event.workflow_run.head_branch }}"
          echo "Commit SHA: ${{ github.event.workflow_run.head_sha }}"
          echo "Triggered by: ${{ github.event.workflow_run.triggering_actor.login }}"
          echo "----------------------------------------"
          echo "Simulating deployment steps:"
          echo "  ‚úì Building Docker image..."
          sleep 2
          echo "  ‚úì Pushing to container registry..."
          sleep 2
          echo "  ‚úì Deploying to staging environment..."
          sleep 2
          echo "  ‚úì Running health checks..."
          sleep 1
          echo "----------------------------------------"
          echo "‚úÖ Deployment to STAGING completed successfully!"
          echo "========================================"

      - name: Deployment Summary
        run: |
          echo "### üéâ Staging Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** Staging" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.event.workflow_run.head_branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.event.workflow_run.head_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ‚úÖ Success (Dummy)" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** https://staging.yomu-bacaan-dan-kuis.example.com" >> $GITHUB_STEP_SUMMARY

  # Dummy deployment to PRODUCTION environment
  deploy-production:
    name: Deploy to Production (Dummy)
    runs-on: ubuntu-latest
    needs: check-ci-success
    # Only run if branch is 'main'
    if: ${{ github.event.workflow_run.head_branch == 'main' }}
    environment:
      name: production
      url: https://yomu-bacaan-dan-kuis.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Dummy Deployment - Production
        run: |
          echo "========================================"
          echo "üöÄ Dummy Deployment: PRODUCTION"
          echo "========================================"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.event.workflow_run.head_branch }}"
          echo "Commit SHA: ${{ github.event.workflow_run.head_sha }}"
          echo "Triggered by: ${{ github.event.workflow_run.triggering_actor.login }}"
          echo "----------------------------------------"
          echo "Simulating deployment steps:"
          echo "  ‚úì Building Docker image..."
          sleep 2
          echo "  ‚úì Pushing to container registry..."
          sleep 2
          echo "  ‚úì Creating backup of current production..."
          sleep 2
          echo "  ‚úì Deploying to production environment..."
          sleep 3
          echo "  ‚úì Running health checks..."
          sleep 2
          echo "  ‚úì Running smoke tests..."
          sleep 1
          echo "----------------------------------------"
          echo "‚úÖ Deployment to PRODUCTION completed successfully!"
          echo "========================================"

      - name: Deployment Summary
        run: |
          echo "### üéâ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.event.workflow_run.head_branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.event.workflow_run.head_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ‚úÖ Success (Dummy)" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** https://yomu-bacaan-dan-kuis.example.com" >> $GITHUB_STEP_SUMMARY

  # Notification job (runs after deployment)
  notify-deployment:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [check-ci-success, deploy-staging, deploy-production]
    if: always()

    steps:
      - name: Deployment Notification
        run: |
          echo "========================================"
          echo "üì¢ Deployment Notification"
          echo "========================================"
          if [[ "${{ needs.deploy-staging.result }}" == "success" ]]; then
            echo "‚úÖ Staging deployment completed successfully"
          elif [[ "${{ needs.deploy-production.result }}" == "success" ]]; then
            echo "‚úÖ Production deployment completed successfully"
          else
            echo "‚ÑπÔ∏è  No deployment was triggered (branch condition not met)"
          fi
          echo "========================================"